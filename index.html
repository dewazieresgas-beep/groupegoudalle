<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accueil - Intranet Goudalle</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <script src="./js/auth.js"></script>
  <script src="./js/utils.js"></script>
  <script>
    // V√©rifier imm√©diatement si connect√©
    if (!Auth.isConnected()) {
      window.location.href = './login.html';
    }
  </script>

  <div class="app-container">
    <div id="sidebar"></div>
    
    <main class="main-content">
      <h1>üè† Tableau de bord</h1>
      
      <div class="card">
        <div class="card-title">
          <h2>üèóÔ∏è Goudalle Ma√ßonnerie</h2>
        </div>
        <div class="card-body">
          <div id="gm-content">Chargement...</div>
          <button onclick="goToGM()" class="btn btn-primary mt-3">Acc√©der au d√©tail</button>
        </div>
      </div>

      <div class="card" id="adminCard" style="display:none;">
        <div class="card-title">
          <h2>‚öôÔ∏è Administration</h2>
        </div>
        <div class="card-body">
          <p>Bienvenue, directeur ! G√©rez les utilisateurs, les donn√©es et les param√®tres du syst√®me.</p>
          <button onclick="goToAdmin()" class="btn btn-primary">Acc√©der √† l'administration</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    function initHome() {
      // Injecter sidebar
      document.getElementById('sidebar').innerHTML = getSidebar();
      
      // Charger donn√©es GM
      const session = Auth.getSession();
      if (!Auth.hasAccess('gm')) {
        document.getElementById('gm-content').innerHTML = '‚ùå Acc√®s refus√© √† Goudalle Ma√ßonnerie';
        return;
      }

      const lastWeek = getLastPublishedWeek();
      if (!lastWeek) {
        document.getElementById('gm-content').innerHTML = '<p>üìä Aucune donn√©e publi√©e encore</p>';
        return;
      }

      const ratio = calculateRatio(lastWeek.hours, lastWeek.m3);
      const smiley = getSmiley(ratio);

      document.getElementById('gm-content').innerHTML = `
        <div class="kpi-grid">
          <div class="kpi-box">
            <div class="kpi-label">Semaine</div>
            <div class="kpi-value">S${String(lastWeek.week).padStart(2, '0')}</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-label">m¬≥ coul√©s</div>
            <div class="kpi-value">${lastWeek.m3.toFixed(2)}</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-label">Heures</div>
            <div class="kpi-value">${lastWeek.hours.toFixed(2)}</div>
          </div>
          <div class="kpi-box ${smiley}">
            <div class="kpi-label">h/m¬≥</div>
            <div class="kpi-value">${ratio !== null ? ratio.toFixed(2) : '‚Äî'}</div>
            <div class="smiley">${getSmileyEmoji(smiley)}</div>
          </div>
        </div>
        <div class="comment-box">
          <strong>Commentaire :</strong> ${lastWeek.comment}
        </div>
      `;

      // Afficher le card admin pour les directeurs
      if (Auth.isDirection()) {
        document.getElementById('adminCard').style.display = 'block';
      }
    }

    function goToGM() {
      window.location.href = './pages/gm.html';
    }

    function goToAdmin() {
      window.location.href = './pages/gm-admin.html';
    }

    // Initialiser
    setTimeout(initHome, 100);
  </script>
</body>
</html>
