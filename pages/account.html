<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil - Intranet Goudalle</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .profile-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid var(--accent);
    }
    .profile-label {
      font-size: 12px;
      color: #7f8c8d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .profile-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }
    .role-badge {
      display: inline-block;
      padding: 8px 12px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
      border-radius: 5px;
      font-weight: 600;
      font-size: 12px;
    }
    .permissions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .permission {
      background: #f0f4ff;
      padding: 10px 12px;
      border-radius: 5px;
      font-size: 13px;
      border-left: 3px solid var(--accent);
    }
  </style>
</head>
<body>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    window.APP_LOGO = 'groupe';
  </script>

  <script>
    Auth.requireAuth();
  </script>

  <div class="app-container">
    <div id="sidebar"></div>
    
    <main class="main-content">
      <h1>Mon Profil</h1>

      <div class="card">
        <div class="card-title">
          <h2>Informations personnelles</h2>
        </div>
        <div class="card-body">
          <div class="profile-grid">
            <div class="profile-card">
              <div class="profile-label">Nom d'utilisateur</div>
              <div class="profile-value" id="username">‚Äî</div>
            </div>
            <div class="profile-card">
              <div class="profile-label">Nom complet</div>
              <div class="profile-value" id="displayName">‚Äî</div>
            </div>
            <div class="profile-card">
              <div class="profile-label">Email</div>
              <div class="profile-value" id="email">‚Äî</div>
            </div>
            <div class="profile-card">
              <div class="profile-label">R√¥le</div>
              <div class="profile-value" id="roleDisplay">‚Äî</div>
            </div>
            <div class="profile-card">
              <div class="profile-label">Connect√© depuis</div>
              <div class="profile-value" id="loginAt">‚Äî</div>
            </div>
            <div class="profile-card">
              <div class="profile-label">Statut</div>
              <div class="profile-value"><span style="color: #27ae60;">‚úÖ Actif</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>Permissions et acces</h2>
        </div>
        <div class="card-body">
          <div id="permissionsDisplay"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>Parametres de securite</h2>
        </div>
        <div class="card-body">
          <div id="message" class="alert" style="display:none;"></div>

          <div style="margin-bottom: 20px;">
            <h4>Changer le mot de passe</h4>
            <form onsubmit="handleChangePassword(event)">
              <div class="form-group">
                <label for="oldPassword">Mot de passe actuel *</label>
                <input type="password" id="oldPassword" required>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                  <label for="newPassword">Nouveau mot de passe *</label>
                  <input type="password" id="newPassword" minlength="3" required>
                </div>
                <div class="form-group">
                  <label for="confirmNewPassword">Confirmer *</label>
                  <input type="password" id="confirmNewPassword" minlength="3" required>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Changer le mot de passe</button>
            </form>
          </div>

          <hr style="margin: 20px 0; opacity: 0.3;">

          <div>
            <h4 style="color: #e74c3c;">Zone de danger</h4>
            <button onclick="resetSession()" class="btn btn-danger">üîÑ Forcer la d√©connexion</button>
            <small style="display: block; margin-top: 10px; color: #7f8c8d;">
              Cela vous d√©connectera imm√©diatement et supprimera votre session.
            </small>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    function loadProfile() {
      document.getElementById('sidebar').innerHTML = getSidebar();

      const session = Auth.getSession();
      if (!session) {
        window.location.href = '../login.html';
        return;
      }

      const user = Auth.getCurrentUser();
      if (!user) {
        window.location.href = '../login.html';
        return;
      }

      // Remplir les champs
      document.getElementById('username').textContent = session.username;
      document.getElementById('displayName').textContent = session.displayName || '‚Äî';
      document.getElementById('email').textContent = session.email || '‚Äî';

      // Role badge
      const roleNames = {
        'direction': 'üóùÔ∏è Direction',
        'referent': 'üìä R√©f√©rent',
        'lecture': 'üëÅÔ∏è Consultation'
      };
      document.getElementById('roleDisplay').innerHTML = `<span class="role-badge">${roleNames[session.role] || session.role}</span>`;

      // Login time
      const loginDate = new Date(session.loginAt);
      document.getElementById('loginAt').textContent = loginDate.toLocaleString('fr-FR');

      // Permissions
      const permissions = Auth.PERMISSIONS[session.role] || [];
      const permissionNames = {
        'gm': 'üìä Consulter les donn√©es Goudalle',
        'gm_saisie': '‚úèÔ∏è Saisir les KPI',
        'gm_admin': '‚öôÔ∏è G√©rer les param√®tres Goudalle',
        'users_admin': 'üë• G√©rer les utilisateurs',
        'thresholds': 'üéöÔ∏è Modifier les seuils',
        'audit': 'üìã Consulter l\'audit'
      };

      const permissionsHtml = permissions.map(p => 
        `<div class="permission">${permissionNames[p] || p}</div>`
      ).join('');

      if (permissions.length === 0) {
        document.getElementById('permissionsDisplay').innerHTML = '<p>Aucune permission attribu√©e</p>';
      } else {
        document.getElementById('permissionsDisplay').innerHTML = `<div class="permissions-grid">${permissionsHtml}</div>`;
      }
    }

    function showMessage(message, type) {
      const msgDiv = document.getElementById('message');
      msgDiv.textContent = message;
      msgDiv.className = `alert alert-${type}`;
      msgDiv.style.display = 'block';
      window.scrollTo(0, 0);
    }

    function handleChangePassword(event) {
      event.preventDefault();

      const session = Auth.getSession();
      const user = Auth.getCurrentUser();
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;

      if (oldPassword !== user.password) {
        showMessage('‚ùå Mot de passe actuel incorrect', 'error');
        return;
      }

      if (newPassword !== confirmNewPassword) {
        showMessage('‚ùå Les nouveaux mots de passe ne correspondent pas', 'error');
        return;
      }

      if (newPassword.length < 3) {
        showMessage('‚ùå Le mot de passe doit faire au moins 3 caract√®res', 'error');
        return;
      }

      const result = Auth.changePassword(session.username, newPassword);
      if (result.success) {
        showMessage(result.message, 'success');
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
      } else {
        showMessage(result.message, 'error');
      }
    }

    function resetSession() {
      if (confirm('√ätes-vous s√ªr ? Vous serez imm√©diatement d√©connect√©.')) {
        Auth.logout();
        window.location.href = '../login.html';
      }
    }

    window.addEventListener('load', loadProfile);
  </script>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div class="footer-title">Goudalle Groupe</div>
        <div>50 rue Principale</div>
        <div>RD343 - 62550 Preures</div>
        <div>Tel. 03 21 90 98 98</div>
      </div>
      <div>
        <div class="footer-title">Contact</div>
        <a class="footer-link" href="#">contact@goudalle.fr</a>
        <div>Formulaire de contact</div>
      </div>
      <div>
        <div class="footer-title">Realisations</div>
        <div>Agricole / Elevage</div>
        <div>Tertiaire / Habitat</div>
        <div>Public / Sante</div>
      </div>
      <div>
        <div class="footer-title">Goudalle recrute</div>
        <div>Decouvrir nos metiers</div>
        <div>Voir nos offres</div>
      </div>
    </div>
  </footer>
</body>
</html>
