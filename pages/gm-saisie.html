<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saisie KPI - Intranet Goudalle</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    window.APP_LOGO = 'maconnerie';
  </script>

  <script>
    Auth.requirePermission('gm_saisie');
  </script>

  <div class="app-container">
    <div id="sidebar"></div>
    
    <main class="main-content">
      <h1>Saisie de KPI - Goudalle Maconnerie</h1>

      <div class="card">
        <div class="card-title">
          <h2>Nouveau KPI</h2>
        </div>
        <div class="card-body">
          <div id="message" class="alert" style="display:none;"></div>

          <form onsubmit="handleSaveKPI(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div class="form-group">
                <label for="year">Ann√©e *</label>
                <input type="number" id="year" value="2026" required>
              </div>
              <div class="form-group">
                <label for="week">Semaine (1-52) *</label>
                <input type="number" id="week" min="1" max="52" value="" required>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div class="form-group">
                <label for="m3">m¬≥ coul√©s *</label>
                <input type="number" id="m3" step="0.01" placeholder="0.00" required>
              </div>
              <div class="form-group">
                <label for="hours">Heures travaill√©es *</label>
                <input type="number" id="hours" step="0.01" placeholder="0.00" required>
              </div>
            </div>

            <div class="form-group">
              <label for="comment">Commentaire obligatoire *</label>
              <textarea id="comment" placeholder="D√©crivez les conditions de travail, les notes importantes, etc." required></textarea>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="publish"> ‚úÖ Publier imm√©diatement
              </label>
              <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                Si coch√©, le KPI sera directement publi√©. Sinon, il restera en brouillon.
              </small>
            </div>

            <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>Mes KPI - Goudalle Maconnerie</h2>
        </div>
        <div class="card-body">
          <table id="kpiTable">
            <thead>
              <tr>
                <th>Semaine</th>
                <th>m¬≥</th>
                <th>Heures</th>
                <th>h/m¬≥</th>
                <th>Statut</th>
                <th>Commentaire</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7" style="text-align:center; padding: 20px;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    function showMessage(message, type) {
      const msgDiv = document.getElementById('message');
      msgDiv.textContent = message;
      msgDiv.className = `alert alert-${type}`;
      msgDiv.style.display = 'block';
    }

    function handleSaveKPI(event) {
      event.preventDefault();

      const year = parseInt(document.getElementById('year').value);
      const week = parseInt(document.getElementById('week').value);
      const m3 = parseFloat(document.getElementById('m3').value);
      const hours = parseFloat(document.getElementById('hours').value);
      const comment = document.getElementById('comment').value.trim();
      const publish = document.getElementById('publish').checked;

      if (!comment) {
        showMessage('‚ùå Le commentaire est obligatoire', 'error');
        return;
      }

      if (m3 <= 0 || hours <= 0) {
        showMessage('‚ùå Les valeurs doivent √™tre sup√©rieures √† 0', 'error');
        return;
      }

      const status = publish ? 'published' : 'draft';
      const kpi = saveKPI(year, week, m3, hours, comment, status);

      showMessage(`‚úÖ KPI S${String(week).padStart(2, '0')}/${year} ${status === 'published' ? 'publi√©' : 'enregistr√© en brouillon'}`, 'success');

      // Reset form
      document.getElementById('year').value = getCurrentYear();
      document.getElementById('week').value = '';
      document.getElementById('m3').value = '';
      document.getElementById('hours').value = '';
      document.getElementById('comment').value = '';
      document.getElementById('publish').checked = false;

      // Refresh list
      loadKPIs();
    }

    function loadKPIs() {
      const kpis = getKPIs().sort((a, b) => b.id - a.id);
      const tbody = document.querySelector('#kpiTable tbody');

      tbody.innerHTML = kpis.map(k => {
        const ratio = calculateRatio(k.hours, k.m3);
        const smiley = getSmiley(ratio);
        return `
          <tr>
            <td><strong>S${String(k.week).padStart(2, '0')}/${k.year}</strong></td>
            <td>${k.m3.toFixed(2)}</td>
            <td>${k.hours.toFixed(2)}</td>
            <td>
              <span class="badge badge-${smiley}">
                ${ratio !== null ? ratio.toFixed(2) : '‚Äî'} ${getSmileyEmoji(smiley)}
              </span>
            </td>
            <td>
              <span class="badge ${k.status === 'published' ? 'badge-success' : 'badge-warning'}">
                ${k.status === 'published' ? '‚úÖ Publi√©' : 'üìù Brouillon'}
              </span>
            </td>
            <td><small>${k.comment}</small></td>
            <td>
              <button class="btn btn-small btn-secondary" onclick="editKPI(${k.id})">‚úèÔ∏è √âditer</button>
              ${k.status !== 'published' ? `<button class="btn btn-small btn-success" onclick="publishKPI(${k.year}, ${k.week})">üì§ Publier</button>` : ''}
            </td>
          </tr>
        `;
      }).join('');

      if (kpis.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px;">Aucun KPI cr√©√©</td></tr>`;
      }
    }

    function editKPI(id) {
      const kpi = getKPIs().find(k => k.id === id);
      if (kpi) {
        document.getElementById('year').value = kpi.year;
        document.getElementById('week').value = kpi.week;
        document.getElementById('m3').value = kpi.m3;
        document.getElementById('hours').value = kpi.hours;
        document.getElementById('comment').value = kpi.comment;
        document.getElementById('publish').checked = kpi.status === 'published';
        window.scrollTo(0, 0);
      }
    }

    function publishKPI(year, week) {
      if (confirm(`Publier le KPI S${String(week).padStart(2, '0')}/${year} ?`)) {
        publishKPI(year, week);
        showMessage('‚úÖ KPI publi√©', 'success');
        loadKPIs();
      }
    }

    function init() {
      document.getElementById('sidebar').innerHTML = getSidebar();
      document.getElementById('year').value = getCurrentYear();
      document.getElementById('week').value = getCurrentWeek();
      loadKPIs();
    }

    window.addEventListener('load', init);
  </script>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div class="footer-title">Goudalle Groupe</div>
        <div>50 rue Principale</div>
        <div>RD343 - 62550 Preures</div>
        <div>Tel. 03 21 90 98 98</div>
      </div>
      <div>
        <div class="footer-title">Contact</div>
        <a class="footer-link" href="#">contact@goudalle.fr</a>
        <div>Formulaire de contact</div>
      </div>
      <div>
        <div class="footer-title">Realisations</div>
        <div>Agricole / Elevage</div>
        <div>Tertiaire / Habitat</div>
        <div>Public / Sante</div>
      </div>
      <div>
        <div class="footer-title">Goudalle recrute</div>
        <div>Decouvrir nos metiers</div>
        <div>Voir nos offres</div>
      </div>
    </div>
  </footer>
</body>
</html>
