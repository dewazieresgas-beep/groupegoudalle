<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Goudalle - Intranet</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    window.APP_LOGO = 'maconnerie';
  </script>

  <script>
    Auth.requirePermission('gm_admin');
  </script>

  <div class="app-container">
    <div id="sidebar"></div>
    
    <main class="main-content">
      <h1>Administration - Goudalle Maconnerie</h1>

      <div class="card">
        <div class="card-title">
          <h2>Seuil de performance (h/mÂ³)</h2>
        </div>
        <div class="card-body">
          <div id="message" class="alert" style="display:none;"></div>

          <form onsubmit="handleSaveThresholds(event)">
            <div class="form-group">
              <label for="ratioThreshold">
                Seuil (h/mÂ³)
                <small style="color: #7f8c8d; display: block;">h/mÂ³ â‰¤ seuil = ğŸŸ¢ Vert / au-dessus = ğŸ”´ Rouge</small>
              </label>
              <input type="number" id="ratioThreshold" step="0.1" value="5" required>
            </div>

            <div class="alert alert-info">
              <strong>â„¹ï¸ RÃ¨gles :</strong>
              <ul style="margin: 10px 0 0 20px;">
                <li>h/mÂ³ â‰¤ seuil = ğŸŸ¢ Vert</li>
                <li>h/mÂ³ &gt; seuil = ğŸ”´ Rouge</li>
              </ul>
            </div>

            <button type="submit" class="btn btn-primary">ğŸ’¾ Enregistrer les seuils</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>Tous les KPI - Goudalle Maconnerie</h2>
        </div>
        <div class="card-body">
          <table id="allKpiTable">
            <thead>
              <tr>
                <th>Semaine</th>
                <th>mÂ³</th>
                <th>Heures</th>
                <th>h/mÂ³</th>
                <th>Statut</th>
                <th>CrÃ©Ã© par</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" style="text-align:center; padding: 20px;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    const THRESHOLDS_KEY = 'goudalle_thresholds';
    let thresholds = {
      ratioThreshold: 5
    };

    function loadThresholds() {
      const stored = localStorage.getItem(THRESHOLDS_KEY);
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (parsed && typeof parsed.ratioThreshold === 'number') {
            thresholds.ratioThreshold = parsed.ratioThreshold;
          } else if (parsed && typeof parsed.orangeMax === 'number') {
            // Ancien format (vert/orange/rouge) : on ignore pour repartir sur la rÃ¨gle Ã  seuil unique.
            thresholds.ratioThreshold = 5;
          }
        } catch {
          const asNum = parseFloat(stored);
          if (Number.isFinite(asNum)) thresholds.ratioThreshold = asNum;
        }
      }
      document.getElementById('ratioThreshold').value = thresholds.ratioThreshold;
    }

    function showMessage(message, type) {
      const msgDiv = document.getElementById('message');
      msgDiv.textContent = message;
      msgDiv.className = `alert alert-${type}`;
      msgDiv.style.display = 'block';
    }

    function handleSaveThresholds(event) {
      event.preventDefault();

      const ratioThreshold = parseFloat(document.getElementById('ratioThreshold').value);
      if (!Number.isFinite(ratioThreshold) || ratioThreshold <= 0) {
        showMessage('âŒ Seuil invalide', 'error');
        return;
      }

      thresholds = { ratioThreshold };
      localStorage.setItem(THRESHOLDS_KEY, JSON.stringify(thresholds));
      Auth.audit('THRESHOLDS_UPDATED', `Seuil mis Ã  jour: ${ratioThreshold} h/mÂ³`);

      showMessage('âœ… Seuils enregistrÃ©s avec succÃ¨s', 'success');
      loadAllKPIs();
    }

    function loadAllKPIs() {
      const kpis = getKPIs().sort(compareByYearWeekDesc);
      const tbody = document.querySelector('#allKpiTable tbody');

      tbody.innerHTML = kpis.map(k => {
        const ratio = calculateRatio(k.hours, k.m3);
        const smiley = getSmiley(ratio);
        const date = new Date(k.updatedAt || k.createdAt);

        return `
          <tr>
            <td><strong>S${String(k.week).padStart(2, '0')}/${k.year}</strong></td>
            <td>${k.m3.toFixed(2)}</td>
            <td>${k.hours.toFixed(2)}</td>
            <td>
              <span class="badge badge-${smiley}">
                ${ratio !== null ? ratio.toFixed(2) : 'â€”'} ${getSmileyEmoji(smiley)}
              </span>
            </td>
            <td>
              <span class="badge ${k.status === 'published' ? 'badge-success' : 'badge-warning'}">
                ${k.status === 'published' ? 'âœ… PubliÃ©' : 'ğŸ“ Brouillon'}
              </span>
            </td>
            <td><small>${k.createdBy}</small></td>
            <td><small>${date.toLocaleDateString('fr-FR')}</small></td>
            <td>
              <button class="btn btn-small btn-secondary" onclick="editKPI(${k.id})">âœï¸ Ã‰diter</button>
              ${k.status !== 'published' ? `<button class="btn btn-small btn-success" onclick="handlePublishKPI(${k.year}, ${k.week})">ğŸ“¤ Publier</button>` : ''}
            </td>
          </tr>
        `;
      }).join('');

      if (kpis.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 20px;">Aucun KPI</td></tr>`;
      }
    }

    function editKPI(id) {
      alert('FonctionnalitÃ© Ã  dÃ©velopper : Ã©diter KPI #' + id);
    }

    function handlePublishKPI(year, week) {
      if (confirm(`Publier le KPI S${String(week).padStart(2, '0')}/${year} ?`)) {
        const result = window.publishKPI(year, week);
        showMessage(result.message, result.success ? 'success' : 'error');
        loadAllKPIs();
      }
    }

    function init() {
      document.getElementById('sidebar').innerHTML = getSidebar();
      loadThresholds();
      loadAllKPIs();
    }

    window.addEventListener('load', init);
  </script>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div class="footer-title">Goudalle Groupe</div>
        <div>50 rue Principale</div>
        <div>RD343 - 62550 Preures</div>
        <div>Tel. 03 21 90 98 98</div>
      </div>
      <div>
        <div class="footer-title">Contact</div>
        <a class="footer-link" href="#">contact@goudalle.fr</a>
        <div>Formulaire de contact</div>
      </div>
      <div>
        <div class="footer-title">Realisations</div>
        <div>Agricole / Elevage</div>
        <div>Tertiaire / Habitat</div>
        <div>Public / Sante</div>
      </div>
      <div>
        <div class="footer-title">Goudalle recrute</div>
        <div>Decouvrir nos metiers</div>
        <div>Voir nos offres</div>
      </div>
    </div>
  </footer>
</body>
</html>
