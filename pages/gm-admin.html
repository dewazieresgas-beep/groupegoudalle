<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Goudalle - Intranet</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    window.APP_LOGO = 'maconnerie';
  </script>

  <script>
    Auth.requirePermission('gm_admin');
  </script>

  <div class="app-container">
    <div id="sidebar"></div>
    
    <main class="main-content">
      <h1>Administration - Goudalle Maconnerie</h1>

      <div class="card">
        <div class="card-title">
          <h2>Seuils de performance (h/m3)</h2>
        </div>
        <div class="card-body">
          <div id="message" class="alert" style="display:none;"></div>

          <form onsubmit="handleSaveThresholds(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div class="form-group">
                <label for="greenMax">
                  ğŸŸ¢ Limite VERT (max)
                  <small style="color: #7f8c8d; display: block;"> h/mÂ³ â‰¤ ce seuil = Vert</small>
                </label>
                <input type="number" id="greenMax" step="0.1" value="4.5" required>
              </div>
              <div class="form-group">
                <label for="orangeMax">
                  ğŸŸ  Limite ORANGE (max)
                  <small style="color: #7f8c8d; display: block;">ce seuil < h/mÂ³ â‰¤ ce seuil = Orange</small>
                </label>
                <input type="number" id="orangeMax" step="0.1" value="5.5" required>
              </div>
            </div>

            <div class="alert alert-info">
              <strong>â„¹ï¸ RÃ¨gles :</strong>
              <ul style="margin: 10px 0 0 20px;">
                <li>h/mÂ³ &lt; Vert = ğŸŸ¢ Vert</li>
                <li>Vert â‰¤ h/mÂ³ â‰¤ Orange = ğŸŸ  Orange</li>
                <li>h/mÂ³ &gt; Orange = ğŸ”´ Rouge</li>
              </ul>
            </div>

            <button type="submit" class="btn btn-primary">ğŸ’¾ Enregistrer les seuils</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>Tous les KPI - Goudalle Maconnerie</h2>
        </div>
        <div class="card-body">
          <table id="allKpiTable">
            <thead>
              <tr>
                <th>Semaine</th>
                <th>mÂ³</th>
                <th>Heures</th>
                <th>h/mÂ³</th>
                <th>Statut</th>
                <th>CrÃ©Ã© par</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" style="text-align:center; padding: 20px;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    let thresholds = {
      greenMax: 4.5,
      orangeMax: 5.5
    };

    function loadThresholds() {
      const stored = localStorage.getItem('goudalle_thresholds');
      if (stored) {
        thresholds = JSON.parse(stored);
      }
      document.getElementById('greenMax').value = thresholds.greenMax;
      document.getElementById('orangeMax').value = thresholds.orangeMax;
    }

    function showMessage(message, type) {
      const msgDiv = document.getElementById('message');
      msgDiv.textContent = message;
      msgDiv.className = `alert alert-${type}`;
      msgDiv.style.display = 'block';
    }

    function handleSaveThresholds(event) {
      event.preventDefault();

      const greenMax = parseFloat(document.getElementById('greenMax').value);
      const orangeMax = parseFloat(document.getElementById('orangeMax').value);

      if (greenMax >= orangeMax) {
        showMessage('âŒ Le seuil VERT doit Ãªtre infÃ©rieur Ã  ORANGE', 'error');
        return;
      }

      thresholds = { greenMax, orangeMax };
      localStorage.setItem('goudalle_thresholds', JSON.stringify(thresholds));
      Auth.audit('THRESHOLDS_UPDATED', `Seuils mis Ã  jour: Vert=${greenMax}, Orange=${orangeMax}`);

      showMessage('âœ… Seuils enregistrÃ©s avec succÃ¨s', 'success');
    }

    function loadAllKPIs() {
      const kpis = getKPIs().sort((a, b) => b.week - a.week);
      const tbody = document.querySelector('#allKpiTable tbody');

      tbody.innerHTML = kpis.map(k => {
        const ratio = calculateRatio(k.hours, k.m3);
        const smiley = getSmiley(ratio);
        const date = new Date(k.updatedAt || k.createdAt);

        return `
          <tr>
            <td><strong>S${String(k.week).padStart(2, '0')}/${k.year}</strong></td>
            <td>${k.m3.toFixed(2)}</td>
            <td>${k.hours.toFixed(2)}</td>
            <td>
              <span class="badge badge-${smiley}">
                ${ratio !== null ? ratio.toFixed(2) : 'â€”'} ${getSmileyEmoji(smiley)}
              </span>
            </td>
            <td>
              <span class="badge ${k.status === 'published' ? 'badge-success' : 'badge-warning'}">
                ${k.status === 'published' ? 'âœ… PubliÃ©' : 'ğŸ“ Brouillon'}
              </span>
            </td>
            <td><small>${k.createdBy}</small></td>
            <td><small>${date.toLocaleDateString('fr-FR')}</small></td>
            <td>
              <button class="btn btn-small btn-secondary" onclick="editKPI(${k.id})">âœï¸ Ã‰diter</button>
              ${k.status !== 'published' ? `<button class="btn btn-small btn-success" onclick="publishKPI(${k.year}, ${k.week})">ğŸ“¤ Publier</button>` : ''}
            </td>
          </tr>
        `;
      }).join('');

      if (kpis.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 20px;">Aucun KPI</td></tr>`;
      }
    }

    function editKPI(id) {
      alert('FonctionnalitÃ© Ã  dÃ©velopper : Ã©diter KPI #' + id);
    }

    function publishKPI(year, week) {
      if (confirm(`Publier le KPI S${String(week).padStart(2, '0')}/${year} ?`)) {
        const result = publishKPI(year, week);
        showMessage(result.message, result.success ? 'success' : 'error');
        loadAllKPIs();
      }
    }

    function init() {
      document.getElementById('sidebar').innerHTML = getSidebar();
      loadThresholds();
      loadAllKPIs();
    }

    window.addEventListener('load', init);
  </script>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div class="footer-title">Goudalle Groupe</div>
        <div>50 rue Principale</div>
        <div>RD343 - 62550 Preures</div>
        <div>Tel. 03 21 90 98 98</div>
      </div>
      <div>
        <div class="footer-title">Contact</div>
        <a class="footer-link" href="#">contact@goudalle.fr</a>
        <div>Formulaire de contact</div>
      </div>
      <div>
        <div class="footer-title">Realisations</div>
        <div>Agricole / Elevage</div>
        <div>Tertiaire / Habitat</div>
        <div>Public / Sante</div>
      </div>
      <div>
        <div class="footer-title">Goudalle recrute</div>
        <div>Decouvrir nos metiers</div>
        <div>Voir nos offres</div>
      </div>
    </div>
  </footer>
</body>
</html>
