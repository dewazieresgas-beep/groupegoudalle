<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goudalle - Dashboard - Intranet</title>
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    Auth.requirePermission('gm');
  </script>

  <div class="app-container">
    <div id="sidebar"></div>
    
    <main class="main-content">
      <h1>ğŸ“Š Goudalle MaÃ§onnerie - Dashboard</h1>

      <div class="card">
        <div class="card-title">
          <h2>ğŸ“ˆ DerniÃ¨re semaine publiÃ©e</h2>
        </div>
        <div class="card-body">
          <div id="lastWeekKpis"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>ğŸ“‰ Tendance 8 semaines</h2>
        </div>
        <div class="card-body">
          <canvas id="kpiChart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>ğŸ“‹ Historique 4 semaines</h2>
        </div>
        <div class="card-body">
          <table id="historyTable">
            <thead>
              <tr>
                <th>Semaine</th>
                <th>mÂ³</th>
                <th>Heures</th>
                <th>h/mÂ³</th>
                <th>Statut</th>
                <th>Commentaire</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" style="text-align:center; padding: 20px;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    let chart;

    function initGM() {
      document.getElementById('sidebar').innerHTML = getSidebar();

      const kpis = getKPIs();
      const published = kpis.filter(k => k.status === 'published').sort((a, b) => b.week - a.week);

      // DerniÃ¨re semaine
      if (published.length > 0) {
        const last = published[0];
        const ratio = calculateRatio(last.hours, last.m3);
        const smiley = getSmiley(ratio);

        document.getElementById('lastWeekKpis').innerHTML = `
          <div class="kpi-grid">
            <div class="kpi-box">
              <div class="kpi-label">Semaine</div>
              <div class="kpi-value">S${String(last.week).padStart(2, '0')}</div>
            </div>
            <div class="kpi-box">
              <div class="kpi-label">mÂ³ coulÃ©s</div>
              <div class="kpi-value">${last.m3.toFixed(2)}</div>
            </div>
            <div class="kpi-box">
              <div class="kpi-label">Heures</div>
              <div class="kpi-value">${last.hours.toFixed(2)}</div>
            </div>
            <div class="kpi-box ${smiley}">
              <div class="kpi-label">h/mÂ³</div>
              <div class="kpi-value">${ratio !== null ? ratio.toFixed(2) : 'â€”'}</div>
              <div class="smiley">${getSmileyEmoji(smiley)}</div>
            </div>
          </div>
          <div class="comment-box">
            <strong>Commentaire :</strong> ${last.comment}
          </div>
        `;
      } else {
        document.getElementById('lastWeekKpis').innerHTML = '<p>âŒ Aucune donnÃ©e publiÃ©e</p>';
      }

      // Chart 8 semaines
      const last8 = published.slice(0, 8).reverse();
      if (last8.length > 0) {
        const labels = last8.map(k => `S${String(k.week).padStart(2, '0')}`);
        const m3Data = last8.map(k => k.m3);
        const hoursData = last8.map(k => k.hours);
        const ratioData = last8.map(k => calculateRatio(k.hours, k.m3));

        const ctx = document.getElementById('kpiChart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'mÂ³ coulÃ©s',
                data: m3Data,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'Heures',
                data: hoursData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'h/mÂ³',
                data: ratioData,
                borderColor: '#f39c12',
                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                yAxisID: 'y1',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: true, position: 'top' }
            },
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: true, text: 'mÂ³ / Heures' }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: { display: true, text: 'h/mÂ³' },
                grid: { drawOnChartArea: false }
              }
            }
          }
        });
      }

      // Historique 4 semaines
      const last4 = published.slice(0, 4).reverse();
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = last4.map(k => {
        const ratio = calculateRatio(k.hours, k.m3);
        const smiley = getSmiley(ratio);
        return `
          <tr>
            <td><strong>S${String(k.week).padStart(2, '0')}/${k.year}</strong></td>
            <td>${k.m3.toFixed(2)}</td>
            <td>${k.hours.toFixed(2)}</td>
            <td>
              <span class="badge badge-${smiley}">
                ${ratio !== null ? ratio.toFixed(2) : 'â€”'} ${getSmileyEmoji(smiley)}
              </span>
            </td>
            <td>
              <span class="badge ${k.status === 'published' ? 'badge-success' : 'badge-warning'}">
                ${k.status === 'published' ? 'âœ… PubliÃ©' : 'ğŸ“ Brouillon'}
              </span>
            </td>
            <td><small>${k.comment}</small></td>
          </tr>
        `;
      }).join('');

      if (last4.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px;">Aucune donnÃ©e</td></tr>`;
      }
    }

    window.addEventListener('load', initGM);
  </script>
</body>
</html>
